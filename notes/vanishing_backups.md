## "Alexandria": The Vanishing Backups

### Problem

A critical backup cron job has silently stopped working 3 days ago. The backup script is located at /opt/backup/backup.sh and should create daily backups in /var/backups/daily/, but no new backups have been created recently.

Looking at the backup directory, you can see old backup files from a few days ago, proving the system used to work. However, there are no error emails, no obvious error logs, and the cron service appears to be running normally.

Fix ALL issues preventing the backups from running, so that backups are created successfully and reliably.

Test directory: /var/backups/daily/
Backup script: /opt/backup/backup.sh

---

### Root Causes

* The mutex lock for protecting the `/opt/backup/backup.sh` did not clean up properly
* The crontab's backup job is pointing to the non-exist backup script `/opt/backup/old_backup.sh`

---

### Details

#### 1. check the backup script

This script will create a lock file as a mutex lock to prevent the the backup script execute concurrently.

```bash
admin@i-0866e3e49c14825af:~$ cat /opt/backup/backup.sh 
#!/bin/bash
# Backup script for critical data

# FIX: Moved lock file to a persistent location inside /opt/backup
LOCK_FILE="/opt/backup/backup.lock"
BACKUP_DIR="/var/backups/daily"
DATA_DIR="/opt/data"
TIMESTAMP=$(date +%Y%m%d_%H%M%S)
BACKUP_FILE="${BACKUP_DIR}/backup_${TIMESTAMP}.tar.gz"

# Check for lock file
if [ -f "$LOCK_FILE" ]; then
    echo "Error: Backup already running (lock file exists)"
    exit 1
fi

# Create lock file
touch "$LOCK_FILE"

# Perform backup
tar -czf "$BACKUP_FILE" -C "$DATA_DIR" . 2>&1

if [ $? -eq 0 ]; then
    echo "Backup successful: $BACKUP_FILE"
    # Remove lock file on success
    rm -f "$LOCK_FILE"
    exit 0
else
    echo "Backup failed!"
    rm -f "$LOCK_FILE"
    exit 1
fi
```

But for some reason the lock did not remove correctly.

```bash
admin@i-0866e3e49c14825af:~$ ls /opt/backup/
backup.lock  backup.sh
```

Fix: remove `/opt/backup/back.lock`

```bash
admin@i-0866e3e49c14825af:~$ sudo rm /opt/backup/backup.lock
```

#### 2. list the crontab jobs 

```bash
admin@i-0866e3e49c14825af:~$ sudo crontab -l -u root
MAILTO="broken@nonexistent.local"
# DO NOT EDIT THIS FILE - edit the master and reinstall.
# (/tmp/crontabhl3tv8j6 installed on Sun Nov 23 18:40:45 2025)
# (Cron version -- $Id: crontab.c,v 2.13 1994/01/17 03:20:37 vixie Exp $)
#Ansible: daily backup job
*/5 * * * * /opt/backup/old_backup.sh > /dev/null 2>&1
```

Fix: change script path to ``

```bash
admin@i-0866e3e49c14825af:~$ sudo crontab -e -u root
admin@i-0866e3e49c14825af:~$ sudo crontab -l -u root
MAILTO="broken@nonexistent.local"
# DO NOT EDIT THIS FILE - edit the master and reinstall.
# (/tmp/crontabhl3tv8j6 installed on Sun Nov 23 18:40:45 2025)
# (Cron version -- $Id: crontab.c,v 2.13 1994/01/17 03:20:37 vixie Exp $)
#Ansible: daily backup job
*/5 * * * * /opt/backup/backup.sh > /dev/null 2>&1
```

#### 3. run backup script

```bash
admin@i-0866e3e49c14825af:/opt/backup$ sudo ./backup.sh 
Backup successful: /var/backups/daily/backup_20251124_071642.tar.gz
```

Check:

```bash
admin@i-0866e3e49c14825af:~/agent$ ./check.sh 
OKadmin@i-0866e3e49c14825af:~/agent$ 
```
